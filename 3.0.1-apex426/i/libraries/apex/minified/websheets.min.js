function ws_Spreadsheet(pThis,pOptions){function msg(pKey){return apex.lang.getMessage(pKey)}function _busyGraphic(pState){1==pState?$x_Show("apexir_LOADER"):($x_Hide("apexir_LOADER"),reInitWS())}function _initDataGrid(){$("div.edit:not(div.readonly)",$("#"+that.spreadsheet_id)[0]).unbind("click").click(function(event){_cellInit(this,event)})}function _initMenus(){var manageMenu={items:[{type:"action",label:msg("PROPERTIES"),hide:!0,icon:"icon-irr-ws-properties",action:function(){that.dialog("WEBSHEET")}},{type:"action",label:msg("TOGGLE_CHECKBOXES"),hide:!0,icon:"icon-irr-ws-toggle-checkboxes",action:function(){that.actions("toggle_checkboxes")}},{type:"separator"},{type:"subMenu",label:msg("COLUMNS"),hide:!0,icon:"icon-irr-ws-col",menu:{items:[{type:"action",label:msg("ADD"),icon:"icon-irr-ws-col-add",action:function(){that.dialog("ADD_COLUMN")}},{type:"action",label:msg("COLUMN_PROPERTIES"),icon:"icon-irr-ws-col-pros",action:function(){that.dialog("COLUMN_PROPERTIES")}},{type:"action",label:msg("LIST_OF_VALUES"),icon:"icon-irr-ws-lov",action:function(){that.dialog("LOV")}},{type:"action",label:msg("COLUMN_GROUPS"),icon:"icon-irr-ws-col-groups",action:function(){that.dialog("GROUP")}},{type:"action",label:msg("VALIDATION"),icon:"icon-irr-ws-validation",action:function(){that.dialog("VALIDATION")}},{type:"action",label:msg("DELETE_COLUMNS"),icon:"icon-irr-ws-col-delete",action:function(){that.dialog("REMOVE_COLUMN")}}]}},{type:"subMenu",label:msg("ROWS"),hide:!0,icon:"icon-irr-ws-row",menu:{items:[{type:"action",label:msg("ADD_ROW"),icon:"icon-irr-ws-col-add",action:function(){apex.navigation.redirect(apex.util.makeApplicationUrl({pageId:"20",debug:"NO",clearCache:"20",itemNames:["WS_APP_ID","P20_IR_ID","P20_DATA_GRID_ID","CURRENT_WORKSHEET_ROW"],itemValues:[gOptions.wsAppId,that.spreadsheet_id,gOptions.dataGridId,""]}))}},{type:"action",label:msg("SET_COLUMN_VALUES"),icon:"icon-irr-ws-col-values",action:function(){that.dialog("SET_COLUMN_VALUE")}},{type:"action",label:msg("REPLACE"),icon:"icon-irr-ws-row-replace",action:function(){that.dialog("REPLACE")}},{type:"action",label:msg("FILL"),icon:"icon-irr-ws-row-fill",action:function(){that.dialog("FILL")}},{type:"action",label:msg("DELETE_ROWS"),icon:"icon-irr-ws-row-delete",action:function(){that.dialog("DELETE_ROWS")}}]}},{type:"action",label:msg("DELETE_DATA_GRID"),hide:!0,icon:"icon-irr-ws-dg-delete",action:function(){that.dialog("DELETE")}},{type:"separator"},{type:"action",label:msg("COPY"),hide:!0,icon:"icon-irr-ws-copy",action:function(){that.dialog("COPY")}},{type:"action",label:msg("HISTORY"),icon:"icon-irr-ws-history",action:function(){apex.navigation.redirect(apex.util.makeApplicationUrl({pageId:"14",debug:"NO"}))}}],beforeOpen:function(event,menu){var i,items=menu.menu.items;for(i=0;8>i;i++)items[i].hide=!gOptions.currentUserIsNotReader}};gOptions.websheetManageDatagridMenu&&$("#apexir_WEBSHEETMENU").menu(manageMenu);var manageReportMenu={items:[{type:"action",label:msg("EDIT_ATTRIBUTES"),action:function(){apex.navigation.redirect(apex.util.makeApplicationUrl({pageId:"3010",debug:"NO",clearCache:"3010",itemNames:["p3010_worksheet_id","p3030_worksheet_id"],itemValues:[that.spreadsheet_id,that.spreadsheet_id]}))}},{type:"action",label:msg("EDIT_QUERY"),action:function(){apex.navigation.redirect(apex.util.makeApplicationUrl({pageId:"3030",debug:"NO",clearCache:"3030",itemNames:["p3010_worksheet_id","p3030_worksheet_id"],itemValues:[that.spreadsheet_id,that.spreadsheet_id]}))}}]};gOptions.websheetManageReportMenu&&gOptions.currentUserIsNotReader&&$("#apexir_WEBSHEETMENU").menu(manageReportMenu)}function _collectChecks(){for(var lReturn=[],lSelect=$x_FormItems(that.spreadsheet_id,"CHECKBOX"),i=0,l=lSelect.length;l>i;i++)lSelect[i].checked&&lSelect[i].id&&(lReturn[lReturn.length]=lSelect[i].value);return lReturn}function _openDialog(pDialog){function _displayButton(pAction,pLabel,pHot,pClose){var lLabel,lStyle;lLabel=pLabel?pLabel:MSG.BUTTON.APPLY,pHot&&(lStyle="ui-button--hot"),lButtons.push({text:lLabel,"class":lStyle,click:function(){that.actions(pAction),pClose&&lWSDlg$.dialog("close")}})}var lWSDlg$,lTitle,lId,lButtons=[{text:MSG.BUTTON.CANCEL,click:function(){lWSDlg$.dialog("close")}}];"WEBSHEET"===pDialog?(lTitle=MSG.DIALOG_TITLE.PROPERTIES,_displayButton("websheet_properties_save",null,!0,!1)):"ADD_COLUMN"===pDialog?(lTitle=MSG.DIALOG_TITLE.ADD_COLUMN,_displayButton("column_add",null,!0,!1)):"COLUMN_PROPERTIES"===pDialog?(lTitle=MSG.DIALOG_TITLE.COLUMN_PROPERTIES,_displayButton("column_properties_save",null,!0,!1)):"LOV"===pDialog?(lTitle=MSG.DIALOG_TITLE.LOV,lId=apex.item("apexir_LOV_ID").getValue(),lId&&_displayButton("lov_delete",MSG.BUTTON.DELETE,!1,!1),_displayButton("lov_save",null,!0,!1)):"GROUP"===pDialog||"GROUP2"===pDialog?(lTitle=MSG.DIALOG_TITLE.COLUMN_GROUPS,lId=apex.item("apexir_GROUP_ID").getValue(),lId&&_displayButton("column_groups_delete",MSG.BUTTON.DELETE,!1,!1),_displayButton("column_groups_save",null,!0,!1)):"VALIDATION"===pDialog?(lTitle=MSG.DIALOG_TITLE.VALIDATION,lId=apex.item("apexir_VALIDATION_ID").getValue(),lId&&_displayButton("VALIDATION_DELETE",MSG.BUTTON.DELETE,!1,!1),_displayButton("VALIDATION_SAVE",null,!0,!1)):"REMOVE_COLUMN"===pDialog?(lTitle=MSG.DIALOG_TITLE.DELETE_COLUMNS,_displayButton("column_remove",MSG.BUTTON.DELETE,!0,!1)):"SET_COLUMN_VALUE"===pDialog?(lTitle=MSG.DIALOG_TITLE.SET_COLUMN_VALUES,_displayButton("set_column_value",null,!0,!1)):"REPLACE"===pDialog?(lTitle=MSG.DIALOG_TITLE.REPLACE,_displayButton("replace_column_value",null,!0,!1)):"FILL"===pDialog?(lTitle=MSG.DIALOG_TITLE.FILL,_displayButton("fill_column_value",null,!0,!1)):"DELETE_ROWS"===pDialog?(lTitle=MSG.DIALOG_TITLE.DELETE_ROWS,_displayButton("delete_rows",MSG.BUTTON.DELETE,!0,!1)):"COPY"===pDialog?(lTitle=MSG.DIALOG_TITLE.COPY_DATA_GRID,_displayButton("copy",MSG.BUTTON.COPY,!0,!1)):"DELETE"===pDialog?(lTitle=MSG.DIALOG_TITLE.DELETE_DATA_GRID,_displayButton("delete_websheet",MSG.BUTTON.DELETE,!0,!1)):"ATTACHMENT"===pDialog?(lTitle=MSG.DIALOG_TITLE.ADD_FILE,_displayButton("ATTACHMENT_SAVE",null,!0,!0)):"NOTE"===pDialog?(lTitle=MSG.DIALOG_TITLE.ADD_NOTE,_displayButton("NOTE_SAVE",null,!0,!1)):"LINK"===pDialog?(lTitle=MSG.DIALOG_TITLE.ADD_LINK,_displayButton("LINK_SAVE",null,!0,!1)):"TAGS"===pDialog&&(lTitle=MSG.DIALOG_TITLE.ADD_TAGS,_displayButton("TAG_SAVE",null,!0,!1)),lWSDlg$=$("#a-IRR-dialog-js",apex.gPageContext$).dialog({modal:!0,dialogClass:"a-IRR-dialog",width:"auto",height:"auto",minWidth:"360",title:lTitle,buttons:lButtons,close:function(){lWSDlg$.dialog("destroy")}})}function _closeDialog(){$("#a-IRR-dialog-js",apex.gPageContext$).dialog("isOpen")&&$("#a-IRR-dialog-js",apex.gPageContext$).dialog("close")}function _cellSave(e,pThis){var lEl;if(that.currentValue!=pThis.value||$(pThis).hasClass("apex-tabular-form-error")){that.currentValue=$v(pThis);var get=new htmldb_Get(null,$v("pFlowId"),"APPLICATION_PROCESS=CELL",gCurrentPage);get.AddNameValue("ACTION","SAVE"),get.AddNameValue("ROW",that.currentRow.id.substring(3)),get.AddNameValue("COLUMN",that.currentCol),get.AddNameValue("VALUE",pThis.value),get.AddNameValue("CHANGE",$(that.currentRow).attr("apex:c"));var lReturn=get.get();if("true"!=lReturn)lEl=$(pThis),lEl.addClass("apex-tabular-form-error"),$("#ajaxMESSAGE").show(),$("#theMESSAGE").html(lReturn),pThis.focus(),"date"===that.currentColType&&lEl.datepicker("show");else{lEl=$(that.currentRow),lEl.attr("apex:c",parseInt(lEl.attr("apex:c"))+1);var c=$(pThis);c.removeClass("apex-tabular-form-error"),$("#ajaxMESSAGE").hide(),_reset()}get=null}else _reset()}function _return(p,pAction){gIsDataGridDetailPage?"true"==p.responseText?($x_Remove("actionsMenu"),that.row($v("apexir_current_row"),pAction)):($s("apexir_DIALOG_MESSAGE",p.responseText),$x_Show("apexir_DIALOG_MESSAGE")):"true"==p.responseText?"delete_websheet"==pAction?document.location="f?p="+$v("pFlowId")+":902:"+$v("pInstance")+"::NO:::":"save_checked"==pAction||("toggle_checkboxes"!=pAction&&_closeDialog(),gRegion$.trigger("apexrefresh")):($s("apexir_DIALOG_MESSAGE",p.responseText),$x_Show("apexir_DIALOG_MESSAGE"))}function _callAction(pAjax,pAction){switch(pAction?pAjax.ajax.addParam("p_widget_action",pAction):null,pAction){case"set_geocode":pAjax.ajax.addParam("x01",$v("apexir_SHUTTLE_RIGHT"));break;case"reset_geocode":break;default:("delete_rows"==pAction||"set_column_value"==pAction||"replace_column_value"==pAction)&&pAjax.ajax.addParam("x01",$u_ArrayToString(_collectChecks(),":")),"column_groups_save"==pAction&&$("#apexir_SHUTTLE_RIGHT option").prop("selected",!0),gIsDataGridDetailPage&&pAjax.ajax.addParam("x03","DETAIL"),pAjax.ajax.AddArrayItems2($x_FormItems("a-IRR-dialog-js"),1)}pAjax._get()}function _cellInit(pThis){var lCell$,lWidth,lValue,lTextEl$,$lTextAreaEl,lRequest;_reset(),that.currentRow=pThis.parentNode.parentNode,that.currentCell=pThis,that.classArray=pThis.className.split(" "),that.currentCol=that.classArray[0],that.currentColTest=!isNaN(that.currentCol.substring(1)),that.currentColType=that.classArray[1],that.currentColMaxLength=that.classArray[3],lCell$=$(pThis).unbind("click"),"text"==that.currentColType&&that.currentColTest?(lWidth=$(pThis.parentNode).outerWidth(),lValue=lCell$.text(),lCell$.html("").css("padding","0"),lTextEl$=$($dom_AddInput(pThis,"TEXT","","",lValue)),lTextEl$.css("width",lWidth).attr("maxlength",that.currentColMaxLength).blur(function(e){_cellSave(e,this)}).keypress(function(e){return 13==e.which?!1:void 0}).focus(),that.currentForm=lTextEl$[0],that.currentValue=lValue):"textarea"==that.currentColType&&that.currentColTest?(lValue=lCell$.html(),lCell$.html("").css("padding","0"),$lTextAreaEl=$($dom_AddTag(pThis,"TEXTAREA")),$lTextAreaEl.css("width","100%").val(lValue).attr("maxlength",that.currentColMaxLength).blur(function(e){_cellSave(e,this)}).focus(),that.currentForm=$lTextAreaEl[0],that.currentValue=lValue):"date"==that.currentColType&&that.currentColTest?(lWidth=$(pThis.parentNode).outerWidth(),lValue=lCell$.text(),lCell$.html("").css("padding","0"),lTextEl$=$($dom_AddInput(pThis,"TEXT","theCal","",lValue)),lTextEl$.css("width",lWidth),that.currentForm=lTextEl$[0],that.currentValue=lValue,lRequest=new apex.ajax.ondemand("get_dtFmt",function(){var l_s=p.readyState;if(1==l_s);else if(2==l_s);else if(3==l_s);else{if(4!=l_s)return!1;var myObject=apex.jQuery.parseJSON(p.responseText);apex.widget.datepicker("#theCal",{buttonText:"Calendar",showTime:myObject.showTime,time24h:myObject.time24h,timeFormat:myObject.timeFormat,defHour:myObject.defHour,defMinute:myObject.defMinute,defAmpm:myObject.defAmpm,defaultDate:apex.util.getDateFromISO8601String(myObject.defaultDate),showOn:"focus",showAnim:"drop",showOtherMonths:!1,changeMonth:!1,changeYear:!1,onClose:function(){_cellSave(null,this)}},myObject.dtFmt,myObject.lang),lTextEl$.focus(),_busyGraphic(l_s)}}),_busyGraphic(1),lRequest.ajax.AddNameValue("COLUMN",that.currentCol),lRequest.ajax.AddNameValue("DATE",lValue),lRequest._get()):"selectlist"==that.currentColType&&that.currentColTest?(lValue=lCell$.text(),$s(that.currentCell,""),apex.server.process("GET_LOV_JSON",{x01:that.spreadsheet_id,x02:that.currentCol},{dataType:"html",success:function(pData){var lBuild=new $d_LOV_from_JSON;lBuild.l_Type="SELECT",lBuild.create(lCell$.parent()[0],pData),$s(lBuild.l_Dom,lValue),lBuild.l_Dom.focus(),lBuild.l_Dom.id="removeMe",$(lBuild.l_Dom).one("blur",function(pEvent){_cellSave(pEvent,this)})}}),that.currentValue=lValue):_reset()}function _reset(){$("#removeMe").remove(),$(that.currentCell).text(that.currentValue).css("padding","").unbind("click").one("click",function(){_cellInit(this)}),that.currentRow=!1,that.currentCell=!1,that.currentForm=!1,that.currentCol=!1}var gRegion$,that=this,gOptions=pOptions,gCurrentPage=$("#pFlowStepId").val(),gHasManageMenu="2"===gCurrentPage||"3000"===gCurrentPage,gIsDataGridPage="2"===gCurrentPage,gIsDataGridDetailPage="20"===gCurrentPage;gOptions&&gOptions.regionId&&(gRegion$=$("#"+gOptions.regionId,apex.gPageContext$)),this.spreadsheet_id=pThis?pThis:!1,this.currentRow=!1,this.classArray=!1,this.currentCell=!1,this.currentForm=!1,this.currentCol=!1,this.currentColType=!1;var MSG={BUTTON:{CANCEL:msg("CANCEL"),DELETE:msg("DELETE"),APPLY:msg("APPLY"),COPY:msg("COPY")},DIALOG_TITLE:{PROPERTIES:msg("DATA_GRID_PROPERTIES"),ADD_COLUMN:msg("ADD_COLUMN"),COLUMN_PROPERTIES:msg("COLUMN_PROPERTIES"),LOV:msg("LIST_OF_VALUES"),COLUMN_GROUPS:msg("COLUMN_GROUPS"),VALIDATION:msg("VALIDATION"),DELETE_COLUMNS:msg("DELETE_COLUMNS"),SET_COLUMN_VALUES:msg("SET_COLUMN_VALUES"),REPLACE:msg("REPLACE"),FILL:msg("FILL"),DELETE_ROWS:msg("DELETE_ROWS"),COPY_DATA_GRID:msg("COPY_DATA_GRID"),DELETE_DATA_GRID:msg("DELETE_DATA_GRID"),ADD_FILE:msg("ADD_FILE"),ADD_NOTE:msg("ADD_NOTE"),ADD_LINK:msg("ADD_LINK"),ADD_TAGS:msg("ADD_TAGS")}};this.closeUpload=function(){$x("P20_X").name="p_t01",$x_Remove("actionsMenu"),that.row($v("apexir_current_row")),$("#wwvFlowForm").removeAttr("target")},this.actions=function(pAction,pThis){var lRequest;if(gIsDataGridDetailPage)if("ATTACHMENT_SAVE"==pAction){$x("P20_X").name="p_ignore_10",$x("apexir_FILE").name="p_t01",$s("P20_DESC",$v("apexir_DESCRIPTION")),$x("apexir_DIALOG_MESSAGE").innerHTML='<img src="/i/processing3.gif" /><iframe name="myNewWin" id="myNewWin" height="100" width="20" style="display:none;" src="/i/processing3.gif"></iframe>',$x("wwvFlowForm").target="myNewWin";{window.setTimeout(function(){apex.submit("ATTACHMENT")},500)}}else lRequest=new apex.ajax.ondemand("websheet_detail",function(){var l_s=p.readyState;if(1==l_s);else if(2==l_s);else if(3==l_s);else{if(4!=l_s)return!1;_return(p,pAction),_busyGraphic(l_s)}}),_busyGraphic(1),pThis?lRequest.ajax.addParam("p_widget_action_mod",pThis):null,_callAction(lRequest,pAction);else lRequest=new apex.ajax.ondemand("websheet",function(){var l_s=p.readyState;if(1==l_s);else if(2==l_s);else if(3==l_s);else{if(4!=l_s)return!1;_return(p,pAction),_busyGraphic(l_s)}}),_busyGraphic(1),_callAction(lRequest,pAction)},this.dialog=function(pDialog,p_X01,p_X02){var lRequest=new apex.ajax.ondemand("DIALOG",function(){var l_s=p.readyState;if(1==l_s);else if(2==l_s);else if(3==l_s);else{if(4!=l_s)return!1;var gReturn=p.responseText;if("LOV_TEXT"==pDialog)$s("apexir_LOV_ENTRIES",gReturn);else{$("#apex_popup_field_help").dialog("isOpen")&&$("#apex_popup_field_help").dialog("close"),$("#a-IRR-dialog-js",apex.gPageContext$).html(gReturn),_openDialog(pDialog),$x("apexir_SHUTTLE_LEFT")&&(window.g_Shuttlep_v01=new dhtml_ShuttleObject("apexir_SHUTTLE_LEFT","apexir_SHUTTLE_RIGHT")),"NOTIFY"==pDialog&&$("#apexir_NOTIFY_INTERVAL").change(function(){$f_Hide_On_Value_Item(this,"apexir_DATEPICKERS","I")}).change();var $lDropFields=$(":input:visible",$("#a-IRR-dialog-js",apex.gPageContext$));$lDropFields.length>0&&$lDropFields[0].focus()}_busyGraphic(l_s)}});_busyGraphic(1),lRequest.ajax.AddNameValue("DIALOG",pDialog),lRequest.ajax.AddNameValue("VALUE",p_X01),lRequest.ajax.AddNameValue("VALUE2",p_X02),gIsDataGridDetailPage&&lRequest.ajax.AddNameValue("MODE","DETAIL"),lRequest._get()},this.collectCheckedRows=function(pThis){$f_CheckFirstColumn(pThis),that.actions("save_checked")},this.selectTest=function(pThis){switch($v(pThis)){case"NEW":$x_Show("apexir_LOV_ATTRIBUTES");break;case"":$x_Hide("apexir_LOV_ATTRIBUTES");break;case"NEW_CURRENT_VALUES":$x_Hide("apexir_LOV_ATTRIBUTES");break;default:that.dialog("LOV_TEXT",$v(pThis)),$s("apexir_LOV_NAME",$f_SelectedOptions(pThis).text),$x_Show("apexir_LOV_ATTRIBUTES")}},this.row=function(pRowId,pAction){var $lContainer,$lSingleEls,$lCompoundEls,$lAllEls,get,i,lArray=[];for(_busyGraphic(1),get=new htmldb_Get(null,$v("pFlowId"),"APPLICATION_PROCESS=ITEM_ROW",gCurrentPage),get.add("GOTO_WORKSHEET_ROW",pRowId,50),void 0!==pAction?get.addParam("x01",pAction):get.addParam("x01",""),$lContainer=$("#row")[0],$lSingleEls=$("input:text,input:hidden,textarea,select",$lContainer),$lCompoundEls=$(":radio:checked",$lContainer),$lAllEls=$($lSingleEls).add($lCompoundEls),i=0;i<$lAllEls.length;i++)lArray[0]=$($lAllEls)[i],get.AddArrayItems(lArray,parseInt($(lArray[0]).attr("name").substr(1),10));get.GetAsync(function(p){var lReturn,lErrFlag,lErrMsg,l_s=p.readyState;if(1==l_s);else if(2==l_s);else if(3==l_s);else{if(4!=l_s)return!1;lReturn=p.responseText,lErrFlag="error"===lReturn.substr(0,5),$x_Remove("MESSAGE"),lErrFlag?(lErrMsg=lReturn.substr(6),$("#ajaxMESSAGE").show(),$("#theMESSAGE").html(lErrMsg)):($("#ajaxMESSAGE").hide(),$("#drop").html(lReturn)),_busyGraphic(l_s)}}),_closeDialog(),get=null},gIsDataGridPage&&(_initDataGrid(),gRegion$.on("apexafterrefresh.datagrid",function(){_initDataGrid()})),gHasManageMenu&&_initMenus()}